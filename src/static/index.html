<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Vanish Terminal</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: system-ui, sans-serif; background: #1a1a2e; color: #eee; min-height: 100vh; }
        .hidden { display: none !important; }

        /* Auth */
        .auth { max-width: 360px; margin: 4rem auto; padding: 2rem; background: #16213e; border-radius: 8px; }
        .auth h2 { margin-bottom: 1.5rem; text-align: center; }
        .auth input { width: 100%; padding: 0.75rem; margin-bottom: 1rem; background: #0f3460; border: 1px solid #1a1a2e; border-radius: 4px; color: #eee; font-family: monospace; text-align: center; letter-spacing: 2px; }
        .auth button { width: 100%; padding: 0.75rem; background: #e94560; border: none; border-radius: 4px; color: white; cursor: pointer; }
        .auth button:hover { background: #ff6b6b; }

        /* Sessions */
        .sessions { max-width: 800px; margin: 2rem auto; padding: 1rem; }
        .sessions h2 { margin-bottom: 1rem; }
        .session-list { display: grid; grid-template-columns: repeat(auto-fill, minmax(180px, 1fr)); gap: 1rem; }
        .session-card { padding: 1rem; background: #16213e; border-radius: 8px; cursor: pointer; border: 1px solid transparent; }
        .session-card:hover { border-color: #e94560; transform: translateY(-2px); }
        .session-card h3 { color: #e94560; font-size: 1rem; }

        /* Terminal */
        .terminal { position: fixed; inset: 0; background: #0c0c0c; display: flex; flex-direction: column; }
        .terminal-header { display: flex; justify-content: space-between; align-items: center; padding: 0.5rem 1rem; background: #1a1a2e; border-bottom: 1px solid #333; }
        .terminal-header span { font-family: monospace; color: #e94560; }
        .terminal-header button { padding: 0.25rem 0.75rem; background: #333; border: none; border-radius: 4px; color: #eee; cursor: pointer; }
        #term {
            flex: 1;
            position: relative;
            overflow: auto;
            font: 14px/1 "Cascadia Code", "Fira Code", "DejaVu Sans Mono", monospace;
            color: #ccc;
            outline: none;
        }
        #term-grid {
            position: absolute;
            top: 4px;
            left: 4px;
        }
        #term-grid span {
            position: absolute;
            white-space: pre;
            display: inline-block;
            overflow: hidden;
        }
    </style>
</head>
<body>
    <div id="auth" class="auth">
        <h2>Enter OTP</h2>
        <form action="/auth" method="POST">
            <input type="text" name="otp" placeholder="One-time code" autocomplete="off" autofocus maxlength="32">
            <button type="submit">Authenticate</button>
        </form>
    </div>

    <div id="sessions" class="sessions hidden">
        <h2>Sessions</h2>
        <div id="session-list" class="session-list"></div>
    </div>

    <div id="terminal" class="terminal hidden">
        <div class="terminal-header">
            <span id="session-name"></span>
            <div>
                <span id="role-badge" style="padding:0.25rem 0.5rem;border-radius:4px;font-size:0.8rem;margin-right:0.5rem;color:#ccc;"></span>
                <button onclick="refresh()">Refresh</button>
                <button onclick="takeover()">Takeover</button>
                <button onclick="disconnect()">Disconnect</button>
            </div>
        </div>
        <div id="term" tabindex="0">
            <div id="term-grid"></div>
        </div>
    </div>

    <script>
        let sse = null;
        let isPrimary = false;
        let termCols = 80, termRows = 24;
        let charWidth = 8.4, charHeight = 17;
        let currentSession = null;
        const cellMap = new Map();  // "x,y" -> DOM element
        const isReadOnly = document.cookie.split('; ').some(c => c === 'ro=1');

        // Measure actual character dimensions from rendered font
        function measureChar() {
            const term = document.getElementById('term');
            const probe = document.createElement('span');
            probe.style.cssText = 'position:absolute;visibility:hidden;white-space:pre;';
            probe.textContent = 'X';
            term.appendChild(probe);
            charWidth = probe.getBoundingClientRect().width;
            charHeight = probe.getBoundingClientRect().height;
            term.removeChild(probe);
        }

        // Check auth on load
        fetch('/api/sessions').then(r => r.ok ? showSessions(r.json()) : null);

        async function showSessions(dataPromise) {
            const data = await dataPromise;
            document.getElementById('auth').classList.add('hidden');
            document.getElementById('sessions').classList.remove('hidden');
            document.getElementById('session-list').innerHTML = data.sessions
                .map(s => `<div class="session-card" onclick="connect('${s.name}')"><h3>${s.name}</h3></div>`)
                .join('') || '<p>No sessions</p>';
        }

        function openSse(name) {
            sse?.close();
            const grid = document.getElementById('term-grid');
            grid.innerHTML = '';
            cellMap.clear();
            sse = new EventSource(`/api/sessions/${encodeURIComponent(name)}/stream`);
            sse.addEventListener('keyframe', e => handleUpdate(JSON.parse(e.data), true));
            sse.addEventListener('delta', e => handleUpdate(JSON.parse(e.data), false));
            sse.addEventListener('exit', disconnect);
            sse.onerror = disconnect;
        }

        function updateRoleBadge() {
            const badge = document.getElementById('role-badge');
            if (isReadOnly) { badge.textContent = 'read-only'; badge.style.background = '#8b4513'; return; }
            badge.textContent = isPrimary ? 'primary' : 'viewer';
            badge.style.background = isPrimary ? '#2d6a4f' : '#444';
        }

        function connect(name) {
            document.getElementById('sessions').classList.add('hidden');
            document.getElementById('terminal').classList.remove('hidden');
            document.getElementById('session-name').textContent = name;
            isPrimary = false;
            currentSession = name;
            updateRoleBadge();
            measureChar();
            const term = document.getElementById('term');
            term.focus();
            term.onkeydown = e => handleKey(e, name);
            if (isReadOnly) document.querySelector('[onclick="takeover()"]').classList.add('hidden');
            openSse(name);
        }

        function handleUpdate(data, isKeyframe) {
            const grid = document.getElementById('term-grid');

            if (isKeyframe) {
                if (data.cols !== termCols || data.rows !== termRows) {
                    grid.innerHTML = '';
                    cellMap.clear();
                    termCols = data.cols;
                    termRows = data.rows;
                    grid.style.width = (termCols * charWidth) + 'px';
                    grid.style.height = (termRows * charHeight) + 'px';
                }
            }

            const frag = document.createDocumentFragment();
            for (const cell of data.cells) {
                const key = `${cell.x},${cell.y}`;
                const existing = cellMap.get(key);
                const span = existing || document.createElement('span');

                span.textContent = cell.c;
                span.style.cssText = `left:${cell.x * charWidth}px;top:${cell.y * charHeight}px;width:${charWidth}px;height:${charHeight}px;line-height:${charHeight}px;${cell.s || ''}`;

                if (!existing) {
                    frag.appendChild(span);
                    cellMap.set(key, span);
                }
            }
            grid.appendChild(frag);
        }

        function disconnect() {
            sse?.close();
            sse = null;
            currentSession = null;
            document.getElementById('terminal').classList.add('hidden');
            document.getElementById('sessions').classList.remove('hidden');
        }

        function sendResize() {
            if (!currentSession || !isPrimary) return;
            const term = document.getElementById('term');
            measureChar();
            const cols = Math.floor(term.clientWidth / charWidth);
            const rows = Math.floor(term.clientHeight / charHeight);
            if (cols > 0 && rows > 0 && (cols !== termCols || rows !== termRows)) {
                fetch(`/api/sessions/${encodeURIComponent(currentSession)}/resize`,
                    { method: 'POST', body: `${cols}x${rows}` });
            }
        }

        window.addEventListener('resize', sendResize);

        function refresh() {
            if (!currentSession) return;
            isPrimary = false;
            updateRoleBadge();
            openSse(currentSession);
        }

        function takeover() {
            if (isReadOnly) return;
            const name = document.getElementById('session-name').textContent;
            fetch(`/api/sessions/${encodeURIComponent(name)}/takeover`, { method: 'POST' })
                .then(r => { if (r.ok) { isPrimary = true; updateRoleBadge(); sendResize(); } });
        }

        function handleKey(e, session) {
            e.preventDefault();
            if (!isPrimary) return;
            const key = e.key, ctrl = e.ctrlKey;
            let data = key.length === 1 ? (ctrl ? String.fromCharCode(key.toLowerCase().charCodeAt(0) - 96) : key) :
                { Enter: '\r', Backspace: '\x7f', Tab: '\t', Escape: '\x1b', ArrowUp: '\x1b[A', ArrowDown: '\x1b[B', ArrowRight: '\x1b[C', ArrowLeft: '\x1b[D', Home: '\x1b[H', End: '\x1b[F', Delete: '\x1b[3~', PageUp: '\x1b[5~', PageDown: '\x1b[6~', Insert: '\x1b[2~' }[key];
            if (data) fetch(`/api/sessions/${encodeURIComponent(session)}/input`, { method: 'POST', body: data });
        }
    </script>
</body>
</html>
